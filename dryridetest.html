<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>DryRide Assistant 🚲</title>
  <style>
    body { font-family: Arial; margin: 2rem; background: #f4f6f8; color: #333; }
    h1 { color: #0078D7; }
    input, select, button { padding: 0.5rem; margin: 0.5rem 0; }
    .info { margin-top: 1rem; padding: 1rem; background: #fff; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>DryRide Assistant ☀️🚴‍♂️</h1>

  <label>Ort:</label>
  <input id="city" placeholder="z. B. Den Haag">
  <br>
  <label>Abfahrtszeit:</label>
  <input type="time" id="departureTime" value="07:30">
  <br>
  <label>Wiederholung:</label>
  <select id="repeat">
    <option value="once">Einmalig</option>
    <option value="daily">Täglich</option>
  </select>
  <br>
  <button onclick="saveRide()">Speichern</button>
  <button onclick="checkWeather()">Jetzt prüfen</button>

  <div id="output" class="info"></div>

  <script>
    async function getWeatherForecast(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&minutely_15=precipitation`;
      const res = await fetch(url);
      const data = await res.json();

      if (!data.minutely_15 || !data.minutely_15.precipitation) {
        throw new Error("Wetterdaten unvollständig oder nicht verfügbar für diesen Ort.");
      }

      const times = data.minutely_15.time.map(t => new Date(t));
      const values = data.minutely_15.precipitation;
      return times.map((time, i) => ({ time, precipitation: values[i] }));
    }

    async function getCoordinates(city) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
      const data = await res.json();
      if (data.length === 0) throw new Error("Ort nicht gefunden.");
      return { lat: data[0].lat, lon: data[0].lon };
    }

    async function checkWeather() {
      const saved = JSON.parse(localStorage.getItem("dryRideSettings"));
      if (!saved) return alert("Bitte zuerst Ort und Zeit speichern.");

      const { city, departureTime } = saved;
      const { lat, lon } = await getCoordinates(city);
      const forecast = await getWeatherForecast(lat, lon);

      const now = new Date();
      const [h, m] = departureTime.split(":").map(Number);
      const targetTime = new Date(now);
      targetTime.setHours(h, m, 0, 0);

      const nextHour = forecast.filter(f => Math.abs(f.time - targetTime) < 60 * 60 * 1000);
      const avgPrecip = nextHour.reduce((sum, p) => sum + p.precipitation, 0) / nextHour.length;

      const output = document.getElementById("output");

      if (avgPrecip > 0.2) {
        const betterSlot = forecast.find(f => f.precipitation < 0.1 && f.time > now);
        if (betterSlot) {
          const diffMins = Math.round((targetTime - betterSlot.time) / 60000);
          output.innerHTML = `☔ Es wird gegen ${departureTime} regnen.<br>
          Vorschlag: Starte ${Math.abs(diffMins)} Minuten ${diffMins > 0 ? "früher" : "später"} (${betterSlot.time.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}).`;
        } else {
          output.innerHTML = `☔ Regen erwartet um ${departureTime}. Kein besseres Zeitfenster gefunden.`;
        }
      } else {
        output.innerHTML = `✅ Kein Regen erwartet um ${departureTime}. Du bleibst trocken!`;
      }
    }

    function saveRide() {
      const city = document.getElementById("city").value;
      const departureTime = document.getElementById("departureTime").value;
      const repeat = document.getElementById("repeat").value;

      if (!city || !departureTime) return alert("Bitte Ort und Zeit angeben.");

      const settings = { city, departureTime, repeat };
      localStorage.setItem("dryRideSettings", JSON.stringify(settings));
      alert("DryRide gespeichert!");

      requestNotificationPermission();
      scheduleCheck();
    }

    function requestNotificationPermission() {
      if ("Notification" in window) {
        Notification.requestPermission().then(result => {
          if (result === "granted") console.log("Benachrichtigungen erlaubt.");
        });
      }
    }

    async function notifyRain() {
      const saved = JSON.parse(localStorage.getItem("dryRideSettings"));
      if (!saved) return;
      const { city, departureTime } = saved;
      const { lat, lon } = await getCoordinates(city);
      const forecast = await getWeatherForecast(lat, lon);

      const now = new Date();
      const [h, m] = departureTime.split(":").map(Number);
      const target = new Date(now);
      target.setHours(h, m, 0, 0);

      const nextHour = forecast.filter(f => Math.abs(f.time - target) < 60 * 60 * 1000);
      const avgPrecip = nextHour.reduce((s, p) => s + p.precipitation, 0) / nextHour.length;

      if (avgPrecip > 0.2 && Notification.permission === "granted") {
        new Notification("🚲 DryRide-Warnung", {
          body: `Regen um ${departureTime} erwartet. Starte lieber früher!`,
        });
      }
    }

    function scheduleCheck() {
      setInterval(notifyRain, 10 * 60 * 1000); // alle 10 Minuten prüfen
    }

    scheduleCheck(); // beim Start aktiv
  </script>
</body>
</html>
